<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>VIC-20 3D - Griglia 44 Assoluta</title>
    <style>
        body { background-color: #1a1a1a; color: #0f0; font-family: 'Courier New', monospace; margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { display: flex; gap: 20px; align-items: flex-start; }
        #screen, #map {
            white-space: pre;
            background: #000;
            color: #0f0;
            font-size: 14px;
            line-height: 1.0;
            padding: 12px;
            border: 2px solid #333;
            letter-spacing: 0;
        }
        #screen { min-width: 520px; }
        #map { max-height: 80vh; overflow: auto; }
        .header { text-align: center; margin-bottom: 6px; font-size: 1.1em; }
        .pane { display:flex; flex-direction:column; align-items:center; }
    </style>
</head>
<body onload="init()">
    <div class="container">
        <div class="pane">
            <div class="header">STANZA <span id="room-num">--</span></div>
            <div id="screen"></div>
        </div>

        <div class="pane">
            <div class="header">MAPPA</div>
            <div id="map"></div>
        </div>
    </div>

    <script>
        let maze = [], p = 0, d = 1;

        function init() {

            maze = [];
            // 1. Inizializza tutte le stanze con tutte le pareti chiuse
            for(let i=0; i<50; i++) {
                maze.push({f:0, r:0, b:0, l:0});
            }
            // 2. Per ogni stanza, decidi le aperture e aggiorna anche la stanza adiacente
            for(let i=0; i<50; i++) {
                // Nord (f)
                if (Math.random() > 0.5) {
                    maze[i].f = 1;
                    const sopra = (i - 5 + 50) % 50;
                    maze[sopra].b = 1;
                }
                // Est (r)
                if (Math.random() > 0.5) {
                    maze[i].r = 1;
                    const destra = (i % 5 === 4) ? i - 4 : i + 1;
                    maze[destra].l = 1;
                }
                // Sud (b)
                if (Math.random() > 0.5) {
                    maze[i].b = 1;
                    const sotto = (i + 5) % 50;
                    maze[sotto].f = 1;
                }
                // Ovest (l)
                if (Math.random() > 0.5) {
                    maze[i].l = 1;
                    const sinistra = (i % 5 === 0) ? i + 4 : i - 1;
                    maze[sinistra].r = 1;
                }
            }

            console.log(maze);
            
            do { p = Math.floor(Math.random() * 50) + 1; } while (p === 25);
            // nessuna rotazione iniziale
            draw();
        }

        function draw() {
            const absS = maze[p-1] || {f:0,r:0,b:0,l:0};
            let s = {...absS};
            // Ruota la stanza in base alla direzione d (1=nord, 2=est, 3=sud, 4=ovest)
            for(let i=0; i<d-1; i++) {
                const oldF = s.f;
                s.f = s.r;
                s.r = s.b;
                s.b = s.l;
                s.l = oldF;
            }
            console.log('Stanza ruotata per rendering:', s);
            document.getElementById('room-num').innerText = p;

            // chiave: L F R (A = aperto, C = chiuso)
            const key = (s.l ? 'A' : 'C') + (s.f ? 'A' : 'C') + (s.r ? 'A' : 'C');

            const templates = {
'AAA': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|  |                                   |  |
|  |                                   |  |
|  |                                   |  |
|  |  |\\                           /|  |  |
|  |  | \\+------+         +------+/ |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  | /+------+         +------+\\ |  |  |
|  |  |/                           \\|  |  |
|  |                                   |  |
|  |                                   |  |
|  |                                   |  |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'AAC': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|  |                                  /   |
|  |                                 /    |
|  |                                /     |
|  |  |\\                           /      |
|  |  | \\+------+         +------+/       |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  | /+------+         +------+\\       |
|  |  |/                           \\      |
|  |                                \\     |
|  |                                 \\    |
|  |                                  \\   |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'ACC': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|  |                                  /   |
|  |                                 /    |
|  |                                /     |
|  |  |\\                           /      |
|  |  | \\+------+---------+------+/       |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  |  |      |         |      |        |
|  |  | /+------+---------+------+\\       |
|  |  |/                           \\      |
|  |                                \\     |
|  |                                 \\    |
|  |                                  \\   |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'ACA': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|  |                                   |  |
|  |                                   |  |
|  |                                   |  |
|  |  |\\                           /|  |  |
|  |  | \\+------+---------+------+/ |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  |  |      |         |      |  |  |  |
|  |  | /+------+---------+------+\\ |  |  |
|  |  |/                           \\|  |  |
|  |                                   |  |
|  |                                   |  |
|  |                                   |  |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'CAC': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|   \\                                 /   |
|    \\                               /    |
|     \\                             /     |
|      \\                           /      |
|       \\+------+         +------+/       |
|        |      |         |      |        |
|        |      |         |      |        |
|        |      |         |      |        |
|        |      |         |      |        |
|       /+------+         +------+\\       |
|      /                           \\      |
|     /                             \\     |
|    /                               \\    |
|   /                                 \\   |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'CAA': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|   \\                                  |  |
|    \\                                 |  |
|     \\                                |  |
|      \\                           /|  |  |
|       \\+------+         +------+/ |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|       /+------+         +------+\\ |  |  |
|      /                           \\|  |  |
|     /                                |  |
|    /                                 |  |
|   /                                  |  |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'CCA': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|   \\                                  |  |
|    \\                                 |  |
|     \\                                |  |
|      \\                           /|  |  |
|       \\+------+---------+------+/ |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|        |      |         |      |  |  |  |
|       /+------+---------+------+\\ |  |  |
|      /                           \\|  |  |
|     /                                |  |
|    /                                 |  |
|   /                                  |  |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`,

'CCC': `+-----------------------------------------+
|\\                                       /|
| \\                                     / |
|  \\                                   /  |
|   \\                                 /   |
|    \\                               /    |
|     \\                             /     |
|      \\                           /      |
|       \\+------+---------+------+/       |
|        |      |         |      |        |
|        |      |         |      |        |
|        |      |         |      |        |
|        |      |         |      |        |
|       /+------+---------+------+\\       |
|      /                           \\      |
|     /                             \\     |
|    /                               \\    |
|   /                                 \\   |
|  /                                   \\  |
| /                                     \\ |
|/                                       \\|
+-----------------------------------------+`
            };

            const lines = (templates[key] || templates['CCC']).split('\n');
            document.getElementById('screen').innerText = lines.map(row => row.padEnd(44, " ")).join("\n");

            renderMap();
        }

        // costruisce la mappa ASCII laterale (5 colonne x 10 righe)
        function renderMap() {
            const cols = 5, rows = 10;
            let mapLines = [];

            // Riga superiore
            let topLine = '';
            for (let cx = 0; cx < cols; cx++) {
                const idx = cx + 1;
                topLine += '+';
                topLine += (maze[idx - 1].f ? '  ' : '--');
            }
            topLine += '+';
            mapLines.push(topLine);

            for (let ry = 0; ry < rows; ry++) {
                // Riga numeri e muri verticali
                let numLine = '';
                for (let cx = 0; cx < cols; cx++) {
                    const idx = ry * cols + cx + 1;
                    numLine += (maze[idx - 1].l ? ' ' : '|');
                    numLine += String(idx).padStart(2, ' ');
                }
                numLine += (maze[ry * cols + cols - 1].r ? ' ' : '|');
                mapLines.push(numLine);

                // Riga muri orizzontali
                let wallLine = '';
                for (let cx = 0; cx < cols; cx++) {
                    const idx = ry * cols + cx + 1;
                    wallLine += '+';
                    wallLine += (maze[idx - 1].b ? '  ' : '--');
                }
                wallLine += '+';
                mapLines.push(wallLine);
            }

            document.getElementById('map').innerText = mapLines.join('\n');
        }

        window.addEventListener('keydown', e => {
            if (e.key === "ArrowRight") { d = d%4 + 1; }
            if (e.key === "ArrowLeft")  { d = d == 1 ? 4 : d - 1; }
            if (e.key === "Enter") {
                const absS = maze[p-1] || {f:0,r:0,b:0,l:0};
                let s = {...absS};
                for(let i=0; i<d-1; i++) {
                    const oldF = s.f;
                    s.f = s.l;
                    s.l = s.b;
                    s.b = s.r;
                    s.r = oldF;
                }
                if (s.f === 1) {
                    let st = (d===3)?5:(d===1)?-5:(d===2)?1:-1;
                    p += st; if(p>50)p-=50; if(p<1)p+=50;
                    if (p === 25) {
                        alert("BRAVO! HAI RAGGIUNTO LA STANZA 25!");
                    }
                    // d resta invariato, nessuna rotazione extra
                }
            }
            draw();
        });
    </script>
</body>
</html>
